<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GPS Offline Tracker</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .status-card { background: white; border-radius: 8px; padding: 20px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .coordinates { font-size: 24px; font-weight: bold; color: #2c3e50; text-align: center; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    .info-item { text-align: center; }
    .info-label { font-size: 14px; color: #7f8c8d; margin-bottom: 5px; }
    .info-value { font-size: 18px; font-weight: bold; color: #34495e; }
    .status-good { color: #27ae60; }
    .status-bad { color: #e74c3c; }
    .trail { background: white; border-radius: 8px; padding: 20px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
    .trail-point { padding: 5px 0; border-bottom: 1px solid #ecf0f1; font-family: monospace; }
    .compass { width: 100px; height: 100px; border: 3px solid #3498db; border-radius: 50%; margin: 0 auto; position: relative; }
    .compass-needle { width: 2px; height: 40px; background: #e74c3c; position: absolute; top: 10px; left: 49px; transform-origin: bottom; }
  </style>
</head>
<body>
  <div class="container">
    <div class="status-card">
      <h1 style="text-align: center; color: #2c3e50;">üõ∞Ô∏è GPS Offline Tracker</h1>
      <div id="status" class="coordinates status-bad">Waiting for GPS fix...</div>
    </div>
    
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">Latitude</div>
        <div id="lat" class="info-value">--</div>
      </div>
      <div class="info-item">
        <div class="info-label">Longitude</div>
        <div id="lon" class="info-value">--</div>
      </div>
      <div class="info-item">
        <div class="info-label">Speed (km/h)</div>
        <div id="speed" class="info-value">--</div>
      </div>
      <div class="info-item">
        <div class="info-label">Last Update</div>
        <div id="time" class="info-value">--</div>
      </div>
    </div>
    
    <div class="status-card">
      <h3>üìç Current Position</h3>
      <div id="coordinates" class="coordinates">No GPS data</div>
      <div style="text-align: center; margin: 20px 0;">
        <div class="compass">
          <div id="compass-needle" class="compass-needle"></div>
        </div>
        <div style="margin-top: 10px;">Compass (N=0¬∞)</div>
      </div>
    </div>
    
    <div class="trail">
      <h3>üìä Position History</h3>
      <div id="trail"></div>
    </div>
  </div>

  <script>
    let trail = [];
    let lastBearing = 0;
    
    async function fetchLocation() {
      try {
        const resp = await fetch('/location');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        
        if (data && data.valid && typeof data.lat === 'number' && typeof data.lon === 'number') {
          // Update status
          document.getElementById('status').textContent = 'GPS Fix: ACTIVE';
          document.getElementById('status').className = 'coordinates status-good';
          
          // Update coordinates
          document.getElementById('lat').textContent = data.lat.toFixed(6) + '¬∞';
          document.getElementById('lon').textContent = data.lon.toFixed(6) + '¬∞';
          document.getElementById('speed').textContent = data.speed_kmh.toFixed(1);
          document.getElementById('time').textContent = new Date(data.updated_at * 1000).toLocaleTimeString();
          
          // Update main coordinate display
          document.getElementById('coordinates').textContent = 
            `${data.lat.toFixed(6)}¬∞, ${data.lon.toFixed(6)}¬∞`;
          
          // Add to trail
          const timestamp = new Date().toLocaleTimeString();
          trail.unshift(`${timestamp}: ${data.lat.toFixed(6)}, ${data.lon.toFixed(6)} (${data.speed_kmh.toFixed(1)} km/h)`);
          if (trail.length > 20) trail.pop(); // Keep last 20 points
          
          // Update trail display
          document.getElementById('trail').innerHTML = 
            trail.map(point => `<div class="trail-point">${point}</div>`).join('');
          
          // Update compass (simplified - just show movement direction)
          if (data.speed_kmh > 1) {
            lastBearing += 5; // Simple animation for demo
            document.getElementById('compass-needle').style.transform = `rotate(${lastBearing}deg)`;
          }
          
        } else {
          document.getElementById('status').textContent = 'Waiting for GPS fix...';
          document.getElementById('status').className = 'coordinates status-bad';
          document.getElementById('coordinates').textContent = 'No GPS data';
        }
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = 'Connection Error';
        document.getElementById('status').className = 'coordinates status-bad';
      }
    }
    
    setInterval(fetchLocation, 2000);
    fetchLocation();
  </script>
</body>
</html>